\documentclass[a4j,papersize,disablejfam,slide,14pt]{jsarticle}
\usepackage[dvipdfmx]{graphicx}
\usepackage{xcolor}
\usepackage{lastpage}
\usepackage{fancyhdr}
\renewcommand{\headrulewidth}{0.0pt}
\pagestyle{fancy}
\lhead{}
\chead{}
\rhead{}
\lfoot{}
\rfoot{\thepage{}/{}\pageref{LastPage}}
\rfoot{}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage[utf8]{inputenc}
\usepackage{bm}
%%----------- documentclass から17行はコピペ．意味はわからず．-----------%
% 参考：
% 	「何かを書き留める何か　LaTeX + jsarticle + slide でスライドを作る」
% 	url: http://xaro.hatenablog.jp/entry/2013/09/26/004920
%------------------------------------------------------------------------%
%\boldmath %太字
%---------------------- 参照式のみ式番号表示 ----------------------%
\usepackage{mathtools}
%------------------------------------------------------------------%

\usepackage{comment}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{array}
\usepackage{amsfonts}
\usepackage{here}
\usepackage{tikz} %drawing
\usepackage{tabularx} %table
\usepackage{longtable}
\usepackage{latexsym} %qed
\usepackage{ascmac}
\usepackage{pxfonts}
\usepackage{color}
\usepackage{listings}
\usepackage{url}

%参考:https://tmsanrinsha.net/post/2011/03/texでソースコードを綺麗に表示する
\definecolor{OliveGreen}{cmyk}{0.64,0,0.95,0.40}
\lstdefinestyle{customR}{
	%参考：http://workspacememory.hatenablog.com/entry/2015/09/11/021843
	language={R},
    showstringspaces={false},% 半角スペースを表示するか（style に依存
	frame={single},framesep={4pt},% 外枠の設定
	numbers={left},stepnumber={1},numberstyle={\footnotesize},numbersep={1zw},% 行番号の設定
	tabsize={4},% タブ幅を 2 に設定
	breaklines={true},% 自動折り返しをオンに
	basicstyle={\ttfamily\footnotesize},%
	commentstyle={\itshape \color[rgb]{0.66,0.66,0.66}},%
	keywordstyle={\color{OliveGreen}},%
    identifierstyle={\color[cmyk]{1.0,0.0,0.0,0.3}},%
	stringstyle={\color[rgb]{0.75,0.58,0.89}}%
}
\lstdefinestyle{customCpp}{
	language={C++},
    showstringspaces={false},% 半角スペースを表示するか（style に依存
	frame={single},framesep={4pt},% 外枠の設定
	numbers={left},stepnumber={1},numberstyle={\footnotesize},numbersep={1zw},% 行番号の設定
	tabsize={4},% タブ幅を 2 に設定
	breaklines={true},% 自動折り返しをオンに
	basicstyle={\ttfamily\footnotesize},%
	commentstyle={\itshape \color[rgb]{0.66,0.66,0.66}},%
	keywordstyle={\color{OliveGreen}},%
    identifierstyle={\color[cmyk]{1.0,0.0,0.0,0.3}},%
	stringstyle={\color[rgb]{0.75,0.58,0.89}}%
}
\lstdefinestyle{customPython}{
	language={Python},
    showstringspaces={false},% 半角スペースを表示するか（style に依存
	frame={single},framesep={4pt},% 外枠の設定
	numbers={left},stepnumber={1},numberstyle={\footnotesize},numbersep={1zw},% 行番号の設定
	tabsize={4},% タブ幅を 2 に設定
	breaklines={true},% 自動折り返しをオンに
	basicstyle={\ttfamily\footnotesize},%
	commentstyle={\itshape \color[rgb]{0.66,0.66,0.66}},%
	keywordstyle={\color{OliveGreen}},%
    identifierstyle={\color[cmyk]{1.0,0.0,0.0,0.3}},%
	stringstyle={\color[rgb]{0.75,0.58,0.89}}%
}
\allowdisplaybreaks[1]
\newcommand{\bhline}[1]{\noalign {\hrule height #1}} %表の罫線を太くする．
\newcommand{\bvline}[1]{\vrule width #1} %表の罫線を太くする．
\newtheorem{Prop}{$Proposition.$}
\newtheorem{Proof}{$Proof.$}
\newcommand{\qed}{% %証明終了
	\relax\ifmmode
		\eqno{%
		\setlength{\fboxsep}{2pt}\setlength{\fboxrule}{0.3pt}
		\fcolorbox{black}{black}{\rule[2pt]{0pt}{1ex}}}
	\else
		\begingroup
		\setlength{\fboxsep}{2pt}\setlength{\fboxrule}{0.3pt}
		\hfill\fcolorbox{black}{black}{\rule[2pt]{0pt}{1ex}}
		\endgroup
	\fi}
\def\max#1#2{\operatorname{max} \left\{ #1,\ #2 \right\}} %最大
\def\min#1#2{\operatorname{min} \left\{ #1,\ #2 \right\}} %最小
\def\sin#1#2{\operatorname{sin}^{#2} #1} %sin
\def\cos#1#2{\operatorname{cos}^{#2} #1} %cos
\def\tan#1#2{\operatorname{tan}^{#2} #1} %tan
\def\sup#1#2{\operatorname*{sup}_{#1} #2 } %上限
\def\inf#1#2{\operatorname*{inf}_{#1} #2 } %下限
\def\Vector#1{{\boldmath #1}} %ベクトルを太字表示
\def\Norm#1{\left\| #1 \right\|} %ノルム
\def\Log#1{\operatorname{log} #1} %log
\def\Det#1{\operatorname{det} \left( #1 \right)} %行列式
\def\Diag#1{\operatorname{diag} \left( #1 \right)} %行列の対角成分
\def\Exp#1{\operatorname{E} \left[ #1 \right]} %期待値
\def\Var#1{\operatorname{V} \left[ #1 \right]} %分散
\def\Cov#1#2{\operatorname{Cov} \left[ #1,\ #2 \right]} %共分散
\def\exp#1{e^{#1}} %指数関数
\def\prob#1{\operatorname{P} \left(\left\{ #1 \right\}\right)} %確率
\def\cprob#1#2{\operatorname{P} \left(\left\{ #1 \ \middle|\ #2 \right\}\right)} %条件付確率
%\renewcommand{\contentsname}{\bm Index}

\begin{document}
\mathtoolsset{showonlyrefs = true}
\begin{thebibliography}{9}
        \bibitem{endo_zuo_kishimoto} {\rm Endo, Zuo, Kishimoto, 
        Modelling Intra-day Stock Price Changes In Terms of
        a Continuous Double Auction System, 
        The Japan Society for Industrial and Applied Mathematics, 
        Vol.16 , No.3, 2006, pp.305-316.}
        \bibitem{li_hui_endo_kishimoto} {\rm Li, Hui, Endo, Kishimoto, A Quantitative Model for Intraday Stock Price
         Changes Based on Order Flows, 
         J Syst Sci Complex, 2014, 27: 208-224.}
        \bibitem{miyazaki} {\rm 宮崎, 日本の証券市場での日中取引間隔と1約定あたり出来高に関する研究, 2011, 筑波大学システム情報工学研究科修士論文.}
        
\end{thebibliography}

\subsection{モデルの変数と式}
	
	遠藤\cite{endo_zuo_kishimoto}と李\cite{li_hui_endo_kishimoto}に倣ってモデルで使う変数を定義する．変数につける添え字$A$と$B$はそれぞれ$ask$と$bid$の意味である．
    待ち行列理論の結果により，状態$i \geq 1$を初期状態とする$M/M/1$のシステムで系内客数が$0$になるまでの時間の分布の
    {\rm Radon-Nikodym}の意味での密度関数は以下の式で表せる．
    \begin{screen}
    	\begin{align}
    		r_i(t) &=
        	\begin{cases}	
        		\frac{i}{t} \exp{-(\lambda + \mu)t} \rho^{\frac{-i}{2}} I_{i}(2t\sqrt{\lambda \mu}) & (t > 0) \\
            	0 & (t \leq 0)
        	\end{cases} \quad (\rho = \lambda/\mu)\\
            &\mbox{$\lambda > 0:$\ 到着率，$\mu > 0:$\ サービス率，$i \geq 1:$\ 初期状態，$I_{k}(x):$\ 第一種変形{\rm Bessel}関数(定義は式(\refeq{eq:bessel_modified_bessel}))．}
    	\end{align}
    \end{screen}
    ここで変数の定義を以下の通りとする:
    \begin{table}[H]
    \label{tb:def_parameters}
    	\centering
    	\caption{モデルで扱う変数の定義}
        \begin{tabular}{l|l} \bhline{1.5pt}
        	変数名 & 定義 \\ \hline \hline
    		$r_A$ & 最良売り気配数量の初期状態(板の移動直後の数量) \\ \hline
            $r_B$ & 最良買い気配数量の初期状態(板の移動直後の数量) \\ \hline
            $\lambda_A$ & 売り指値注文の到着率(1秒あたり注文数) \\ \hline
            $\lambda_B$ & 買い指値注文の到着率(1秒あたり注文数) \\ \hline
            $\mu_A$ & 買い成行注文の到着率(1秒あたりの注文数とキャンセル数の和\footnotemark) \\ \hline
            $\mu_B$ & 売り成行注文の到着率(1秒あたりの注文数とキャンセル数の和) \\ \hline
            $\rho_A$ & $\lambda_A / \mu_A$ \\ \hline
            $\rho_B$ & $\lambda_B / \mu_B$ \\ \hline
            $T_A$ & 最良売り気配数量が消滅するまでの時間 \\ \hline
            $T_B$ & 最良買い気配数量が消滅するまでの時間 \\ \hline
            $T_U$ & 最良買い気配板が消滅する前に最良売り気配の板が消滅する時間\\ \hline
            $T_D$ & 最良売り気配板が消滅する前に最良買い気配の板が消滅する時間\\ \hline
            $T_M$ & 最良買い気配板か最良売り気配のどちらかの板が消滅する時間\\ \bhline{1.5pt}
        \end{tabular}
    \end{table}
    \footnotetext{板の厚みを減らすのは成行注文だけでなく，指値注文のキャンセルも重要な因子となる．モデルの仮定では注文もキャンセルもそれぞれ或るパラメータの
    {\rm Poisson}到着をしてどの到着も独立であると仮定している．この下でなら，キャンセルを成行注文の中に含めても{\rm Poisson}分布の再生性により
    成行注文が{\rm Poisson}到着すると考えることは妥当である．}
    
\underline{\large 上下板の消滅時間の分布}\\
    上記の変数を用いて最良気配の板が消滅するまでの時間の分布の密度関数を表記する．
    \begin{align}
    	f_A(t) &\equiv 
        \begin{cases}
        		\frac{r_A}{t} \exp{-(\lambda_A + \mu_A)t} {\rho_A}^{\frac{-r_A}{2}} I_{r_A}(2t\sqrt{\lambda_A \mu_A}) & (t > 0) \\
            	0 & (t \leq 0)
        \end{cases},\\
        f_B(t) &\equiv 
        \begin{cases}
        		\frac{r_B}{t} \exp{-(\lambda_B + \mu_B)t} {\rho_B}^{\frac{-r_B}{2}} I_{r_B}(2t\sqrt{\lambda_B \mu_B}) & (t > 0) \\
            	0 & (t \leq 0)
        \end{cases}.
    \end{align}
    
    密度関数を用いて，板の消滅が有限時間内に発生する確率$\prob{T < \infty}$と消滅までの平均時間を次のように表すことができる．これらは
    指値と成行の注文の到着率の比$(\lambda/\mu)$によって場合分けされる．
    \begin{align}
    	P_A \equiv \prob{T_A < \infty} &= \int_{0}^{\infty} f_A(t) dt =
        \begin{cases}
        	1. & \rho_A \leq 1  \\
            \rho_A^{-r_A}. & \rho_A > 1
        \end{cases} \\
        P_B \equiv \prob{T_B < \infty} &= \int_{0}^{\infty} f_B(t) dt =
        \begin{cases}
        	1. & \rho_B \leq 1  \\
            \rho_B^{-r_B}. & \rho_B > 1
        \end{cases}
    \end{align}
    
    \begin{align}
    	\Exp{T_A} &= \begin{cases}
        	\frac{r_A}{\mu_A - \lambda_A}. & \rho_A < 1 \\
        	\infty. & \rho_A \geq 1
        \end{cases}\\
        \Exp{T_B} &= \begin{cases}
        	\frac{r_B}{\mu_B - \lambda_B}. & \rho_B < 1 \\
        	\infty. & \rho_B \geq 1
        \end{cases}
    \end{align}
    
\underline{\large 板が移動する時間間隔の分布}\\
    最良買い気配板が消滅する前に最良売り気配の板が消滅する(板が上に移動する)時間$T_U$の分布は
    \begin{align}
    	\prob{T_U \leq t} &= \prob{\mbox{最良売り気配板が時間$t$内に消滅する}} \\
        &\quad- \prob{\mbox{最良買い気配板が消滅した後に最良売り気配板が時間$t$内に消滅する}} \\
        &= \prob{T_A \leq t} - \prob{T_B \leq T_A \leq t} \\
        &= \int_{0}^{t} f_A(\tau)d\tau - \int_{0}^{t} f_A(\tau) \left( \int_{0}^{\tau} f_B(s)ds \right) d\tau, \quad (t>0)
    \end{align}
    と表される．最右辺を微分して$T_U$の分布の密度関数$f_U(t)$を得る(被積分関数が連続であるから微分可能)．
    \begin{align}
    	f_U(t) \equiv \begin{cases}
        	f_A(t) - f_A(t) \left( \int_{0}^{t} f_B(\tau)d\tau \right), & t>0, \\
            0, & t \leq 0.
    	\end{cases}
    \end{align}
    
    同様にして最良売り気配板が消滅する前に最良買い気配の板が消滅する(板が下に移動する)時間$T_D$の分布の密度関数は
    \begin{align}
    	f_D(t) \equiv \begin{cases}
        	f_B(t) - f_B(t)\left( \int_{0}^{t}f_A(\tau)d\tau \right), & t>0, \\
            0, & t \leq 0,
        \end{cases}
    \end{align}
    と表される．有限時間内に板が上に動く確率$P_U$，下に動く確率$P_D$，変動(上に動く事象と下に動く事象の和事象)が起こる確率$P_M$は次のように表現される．
    \begin{align}
    	P_U \equiv \prob{T_U < \infty} &= \int_{0}^{\infty} f_U(t) dt \\
        &= \int_{0}^{\infty} f_A(t)dt - \int_{0}^{\infty} f_A(t) \left( \int_{0}^{t} f_B(\tau)d\tau \right) dt \\
        &= P_A - \int_{0}^{\infty} f_A(t) \left( \int_{0}^{t} f_B(\tau)d\tau \right) dt, \\
        P_D \equiv \prob{T_D < \infty} &= \int_{0}^{\infty} f_D(t) dt \\
        &= \int_{0}^{\infty} f_B(t)dt - \int_{0}^{\infty} f_B(t) \left( \int_{0}^{t} f_A(\tau)d\tau \right) dt \\
        &= P_B - \int_{0}^{\infty} f_B(t) \left( \int_{0}^{t} f_A(\tau)d\tau \right) dt. \\
    \end{align}
    ここで最終式の第二項について，被積分関数が非負で可積分であるから{\rm Fubini}の定理の適用で積分の順序交換が正当化される:
    \begin{align}
    	\int_{0}^{\infty} f_B(t) \left( \int_{0}^{t} f_A(\tau)d\tau \right) dt = \int_{0}^{\infty} f_A(t) \left( \int_{t}^{\infty} f_B(\tau)d\tau \right) dt
    \end{align}
    この変形式を元の式に代入することで，$P_M$は次の表現になる．
    \begin{align}
    	P_M = \prob{T_M < \infty} &\equiv P_U + P_D \\
        &= P_A - \int_{0}^{\infty} f_A(t) \left( \int_{0}^{t} f_B(\tau)d\tau \right) dt + 
        	P_B - \int_{0}^{\infty} f_A(t) \left( \int_{t}^{\infty} f_B(\tau)d\tau \right) dt \\
        &= P_A + P_B - \int_{0}^{\infty} f_A(t) \left( \int_{0}^{\infty} f_B(\tau)d\tau \right) dt \\
        &= P_A + P_B - P_A P_B \\
        &= \begin{cases}
        	1, & \rho_A \leq 1\ or\ \rho_B \leq 1, \\
            \alpha(< 1), & \rho_A > 1\ and\ \rho_B > 1.
        \end{cases}
    \end{align}
    
    変動が起こるまでの時間$T_M$の平均値は次のように表せる．
    \begin{align}
    	\int_{0}^{\infty} t d\prob{T_M \leq t} &= \int_{0}^{\infty} t d(\prob{T_U \leq t} + \prob{T_D \leq t}) \\
        &= \int_{0}^{\infty} t f_U(t) dt + \int_{0}^{\infty} t f_D(t) dt.
    \end{align}
    
\underline{\large 状態推移行列}\\
    「板が上昇する」「板が下降する」を二種類の状態と見做して，直前に上昇し続けて上昇する確率$p_{UU}$，直前に上昇し次に下降する確率$p_{UD}$，
    直前に下降し続けて下降する確率$p_{DD}$，直前に下降し次に上昇する確率$p_{DU}$の四つの転移確率を定義する．注文の時間間隔が独立に指数分布に従っていると仮定している
    下で，その無記憶性からこの状態推移は{\rm Marcov}過程と考えることができる．転移行列$P$は次のように表せる．
    \begin{align}
    	P \equiv \left(
    	\begin{array}{@{\,}cc@{\,}}
    		p_{UU} & p_{UD} \\
            p_{DU} & p_{DD}
    	\end{array}
    	\right). \\ \label{eq:transient_probability_matrix}
    \end{align}
    $f_A(t)(f_B(t))$は$r_A(r_B)$に，$f_U(t)$と$f_D(t)$は$r_A$と$r_B$の両方に依存する関数であったから，応用のために
    $f_A(t \mid r_A), f_B(t \mid r_B), f_U(t \mid r_A, r_B), f_D(t \mid r_A, r_B)$と表記し直す．ここで，板が上昇した直後の
    上下板の初期状態をそれぞれ$r_A^U, r_B^U$，板が下降した直後の上下板の初期状態をそれぞれ$r_A^D, r_B^D$と表記すると，
    先の転移確率は次の式で表せる．
    \begin{align}
    	p_{UU} &= \int_{0}^{\infty} f_U(t \mid r_A^U, r_B^U) dt = \int_{0}^{\infty} f_A(t \mid r_A^U)dt - \int_{0}^{\infty} f_A(t \mid r_A^U) \left( \int_{0}^{t} f_B(\tau \mid r_B^U)d\tau \right) dt, \\
        p_{UD} &= \int_{0}^{\infty} f_D(t \mid r_A^U, r_B^U) dt = \int_{0}^{\infty} f_B(t \mid r_B^U)dt - \int_{0}^{\infty} f_B(t \mid r_B^U) \left( \int_{0}^{t} f_A(\tau \mid r_A^U)d\tau \right) dt, \\
        p_{DU} &= \int_{0}^{\infty} f_U(t \mid r_A^D, r_B^D) dt = \int_{0}^{\infty} f_A(t \mid r_A^D)dt - \int_{0}^{\infty} f_A(t \mid r_A^D) \left( \int_{0}^{t} f_B(\tau \mid r_B^D)d\tau \right) dt, \\
        p_{DD} &= \int_{0}^{\infty} f_D(t \mid r_A^D, r_B^D) dt = \int_{0}^{\infty} f_B(t \mid r_B^D)dt - \int_{0}^{\infty} f_B(t \mid r_B^D) \left( \int_{0}^{t} f_A(\tau \mid r_A^D)d\tau \right) dt.
    \end{align}
    先の転移行列を有つ{\rm Marcov}過程の定常分布を計算しておく．考えている状態は「上昇する」と「下降する」の二種類であるから，
    上昇する確率を$p_U$，下降する確率を$p_D$と表記しておく．この分布$\pi \equiv (p_U,\ p_D)$が定常となる場合を考える．
    定常分布と転移行列$P$を用いて次の関係(平衡方程式)が成り立つ．
    \begin{align}
    	\pi P = \pi.
    \end{align}
    この式を満たすような分布$\pi$を求める．これは行列$P$についての固有値問題を解くことにもなると示しておく．表記の便宜を図って
    \begin{align}
    	(x,y) \left(
    	\begin{array}{@{\,}cc@{\,}}
    		a & 1-a \\
            1-b & b
    	\end{array}
    	\right)
        = \lambda(x,y), \quad (0 \leq a, b, x, y \leq 1,\ x+y=1), \label{eq:balance_equation}
    \end{align}
    を解く．固有方程式は
    \begin{align}
    	\lambda^2 - (a + b)\lambda + ab - (1-a)(1-b)
        &= \lambda^2 - (a + b)\lambda + a + b - 1 \\
        &= (\lambda - 1)(\lambda - a - b + 1) \\
        &= 0,
    \end{align}
    であるから，定常分布の計算は式(\refeq{eq:balance_equation})にて行列の固有値$1$の固有ベクトルを計算することと同じである．
    連立方程式を解けば結果は$(1-a)x=(1-b)y$であると判り，$a,b$を$p_{UU}, p_{DD}$で置き換えれば次の結果を得る．
    \begin{align}
    	p_U &= \frac{1-p_{DD}}{1 - p_{UU} + 1 - p_{DD}} = \frac{p_{DU}}{p_{UD}+p_{DU}}, \\
        p_D &= \frac{1-p_{UU}}{1 - p_{UU} + 1 - p_{DD}} = \frac{p_{UD}}{p_{UD}+p_{DU}}. \label{eq:stationary_dist}
    \end{align}
    
\underline{\large 確率的初期状態}\\
    板の初期状態が或る分布に従っていると考える．板の初期状態がその分布に従う確率変数$R_A, R_B$で与えられ両者の分布が独立である場合に，上下板それぞれについて先に消滅する
    時間の密度関数$f_U^R,f_D^R$は先の$f_U(t \mid r_A, r_B), f_D(t \mid r_A, r_B)$を用いて次のように表現できる．
    \begin{align}
    	f_U^R (t) \equiv \int_{0}^{\infty}\!\!\!\int_{1}^{\infty} f_U(t \mid r_A, r_B) d\prob{R_A = r_A}d\prob{R_B = r_B}, \\
        f_D^R (t) \equiv \int_{0}^{\infty}\!\!\!\int_{1}^{\infty} f_D(t \mid r_A, r_B) d\prob{R_A = r_A}d\prob{R_B = r_B}.
    \end{align}
    これも{\rm Fubini}の定理による．
    \begin{align}
    	\prob{T_U \leq t} &= \int_{0}^{\infty}\!\!\!\int_{0}^{\infty} \left( \int_{0}^{t} f_U(\tau \mid r_A, r_B) d\tau \right) d\prob{R_A = r_A}d\prob{R_B = r_B} \\
        &= \int_{0}^{t} \left( \int_{0}^{\infty}\!\!\!\int_{0}^{\infty} f_U(\tau \mid r_A, r_B) d\prob{R_A = r_A}d\prob{R_B = r_B} \right) d\tau, \\
    	\Rightarrow f_U^R (t) &= \int_{0}^{\infty}\!\!\!\int_{0}^{\infty} f_U(t \mid r_A, r_B) d\prob{R_A = r_A}d\prob{R_B = r_B}. \hfill \qed
    \end{align}

\subsection{抽出データ}
    実際のデータから取り出した，指値/成行注文の頻度，一回の注文枚数，最良気配値の上昇/下降回数を表にしたものを掲示する．
    注文の頻度と板の上下変動回数については，各日の前場後場毎に数えられたものから平均，標準偏差などを計算している．
    \begin{table}[H]
    	\centering
        \caption{指値/成行注文の頻度, 一回の注文枚数, 最良気配値の上昇/下降回数\ ($2007$年)}
        \fontsize{6pt}\selectfont
    	\begin{tabularx}{\linewidth}{l||lllllll} \bhline{1.5pt}
        \label{tb:statistics_parameters}
        	  & {\rm Mean} & {\rm S.D.} & {\rm Median} & {\rm Kurtosis} & {\rm Skewness} & {\rm Minimum} & {\rm Maximum} \\ \hline
			{\rm Arrival Frequency of Market Buy Orders} & $1874.5512295082$ & $907.457993347613$ & $1820.5$ & $5.11767451501856$ & $0.675337509991397$ & $71$ & $6360$ \\ \hline
			{\rm Arrival Frequency of Market sell Orders} & $1885.09221311475$ & $953.983272328056$ & $1821$ & $6.79006081829123$ & $0.984428247560377$ & $71$ & $8120$ \\ \hline
			{\rm Arrival Frequency of canceled Buy Orders} & $1665.64344262295$ & $548.418678697007$ & $1591.5$ & $4.34069326524823$ & $1.0223638226889$ & $664$ & $3738$ \\ \hline
			{\rm Arrival Frequency of canceled sell Orders} & $1619.41803278689$ & $547.114909569955$ & $1536.5$ & $4.37945019113223$ & $1.02533665819909$ & $579$ & $3781$ \\ \hline
			{\rm Arrival Frequency of limit Buy Orders} & $3653.97336065574$ & $1181.78855390768$ & $3652$ & $4.05675797950432$ & $0.270126754158371$ & $732$ & $8157$ \\ \hline
			{\rm Arrival Frequency of limit sell Orders} & $3563.19057377049$ & $1145.30183541394$ & $3508$ & $4.68143888199017$ & $0.408568143055593$ & $620$ & $9012$ \\ \hline
			{\rm Averege Pieces of One Market Buy Order} & $12.5206451488378$ & $2.77323438747951$ & $12.4681411546065$ & $3.09574522739222$ & $-0.251787164006476$ & $3.56578947368421$ & $19.3492990654206$ \\ \hline
			{\rm Averege Pieces of One Market sell Order} & $12.4193657939448$ & $2.9010116850716$ & $12.4853634546859$ & $3.03603809159898$ & $-0.467023405948823$ & $3.66887417218543$ & $18.7199881726789$ \\ \hline
			{\rm Averege Pieces of One canceled Buy Order} & $9.67245218614441$ & $2.00315704051638$ & $9.37503694441844$ & $5.71568254649852$ & $1.32236478548353$ & $5.98338870431894$ & $19.3528114663727$ \\ \hline
			{\rm Averege Pieces of One canceled sell Order} & $9.81634156546921$ & $2.22155817463813$ & $9.34956284664529$ & $5.43345907724932$ & $1.3486729418014$ & $4.8828903654485$ & $19.7518610421836$ \\ \hline
			{\rm Averege Pieces of One limit Buy Order} & $9.14417038292241$ & $1.68568811350152$ & $8.89759617833488$ & $4.28773924054411$ & $0.915406332348662$ & $5.73312765136907$ & $15.9323899371069$ \\ \hline
			{\rm Averege Pieces of One limit sell Order} & $9.40128432350844$ & $1.90029143582777$ & $9.10787585849688$ & $3.73751115997436$ & $0.927845553013401$ & $5.66795366795367$ & $16.4413665743306$ \\ \hline
			{\rm Upmovement Times Of the Best Bid} & $120.290983606557$ & $75.1582407362664$ & $101$ & $14.0082219500023$ & $2.43447280583046$ & $17$ & $719$ \\ \hline
			{\rm Downmovement Times Of the Best Bid} & $92.8709016393443$ & $55.685698856088$ & $82$ & $20.9273670184347$ & $2.97402869075286$ & $14$ & $610$ \\ \hline
			{\rm Upmovement Times Of the Best Ask} & $93.0409836065574$ & $54.7743397619828$ & $80$ & $16.8868891795264$ & $2.67172775656591$ & $12$ & $558$ \\ \hline
			{\rm Downmovement Times Of the Best Ask} & $119.463114754098$ & $75.5175617154362$ & $99.5$ & $18.1165736972318$ & $2.71213913991385$ & $14$ & $794$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}
    
    上表に示したデータの抽出方法を記述する．全てデータはザラバ開始後 $\sim$ 場の引けまでの間から抽出する．これは寄付の約定が確認された直後から引けの約定が確認される
    直前までのことである．まず成行注文について，注文回数は約定の回数に等しい．約上の直後で板が上下しない場合は約定枚数を注文枚数と数える．
    しかし約上の前後のデータを見ていると板にかかる累積枚数の変化量と約定枚数が一致しない場合がある．
    この場合はその増減に応じて指値注文または注文のキャンセルがあったと判断して，その回数と枚数を記録する．約定を挟んで板が上下する場合，
    成行注文枚数と約定枚数が一致するとは限らない．板にかかる枚数より多い成行注文が来れば，余りの注文枚数は上下した後の板の厚み(初期デプス)となるのである．
    余りの成行注文枚数があるかないかは板の移動直後の上下最良気配値の差額で判断する．通常上下板は$1$ティック$10$円離れているから，移動直後も
    $1$ティックの差であるなら成行注文枚数は約定枚数と余り枚数の和と見做す．約定直後で板が$2$ティック以上離れている場合，
    成行注文の余りは無かったとして約定枚数を成行注文枚数とする．約定を挟まずに板が上下する場合もある．例えば板が$2$ティック以上離れている下で
    買い板が上昇したらそれは指値注文として記録し，その他にも直前に約定がなくて買い板が下降すれば注文のキャンセルとして記録する．
    売りの場合は逆を考えれば良い．約定も板の上下も無い下での板の累積枚数の変化は，
    その増減に応じて指値注文または注文のキャンセルとして記録する．上下板の初期デプス(後述)に関しては，上下板が同時に動いたときのみを記録する．
    表\ref{tb:def_parameters}に掲載したモデル式内のパラメータについても，実際のデータから抽出したものを掲示しておく．
    \mbox{}\\
    
\underline{\large 初期デプス}\\
    板の移動直後の上下板の厚み，すなわち待ち行列の初期状態を表すパラメータについて$1$枚単位($1$枚$=1000$株)で表示する．データは
    最良気配値が$1$ティック離れている箇所のみを抽出した．これはモデルが上下の最良気配値の差額を常に$10$円と仮定しているためである．
    \begin{table}[H]
    	\centering
        \caption{最良気配の移動直後の最良気配の厚み(枚)\ ($2007$年)}
    	\begin{tabularx}{\linewidth}{l||llll} \bhline{1.5pt}
        	{\rm Initial Depth} & {\rm Best Ask (After Up)} & {\rm Best Bid (After Up)} & {\rm Best Ask (After Down)} & {\rm Best Bid (After Down)} \\ \hline \hline
            {\rm Mean} & $420.484997$ & $40.29340868$ & $40.31588898$ & $421.7710303$ \\ \hline
            {\rm S.D.} & $218.9372442$ & $63.17343688$ & $63.39659637$ & $211.8249755$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}
    
    板の移動直後の厚みの頻度図を見ると，これは或る確率分布に従っていると推測される．{\rm Gamma}分布に従っていると仮定した下で，
    最尤法により推定したパラメータで計算される密度関数と実際の観測された分布を下図に表す．
    \begin{align}
    	\mbox{密度関数：}f(x) = \frac{1}{\Gamma(\alpha)\beta^\alpha} x^{\alpha-1} e^{-x/\beta}, \quad(x > 0).
    \end{align}
    \begin{table}[H]
    	\centering
        \caption{{\rm Gamma}分布推定パラメータ}
        \begin{tabularx}{\linewidth}{l||lll|ll} \bhline{1.5pt}
        	{\rm } & 板上昇直後 & & & 板下降直後 & \\ \hline
        	{\rm } & \alpha & \beta & & \alpha & \beta \\ \hline \hline
			{\rm Best bid} & $0.680112458$ & $59.24521486$ & & $3.849663935$ & $109.5604804$ \\ \hline
			{\rm Best ask} & $3.805877022$ & $110.4830751$ & & $0.673427365$ & $59.86672222$ \\ \bhline{1.5pt}
        \end{tabularx}
        \label{tab:initial_depth_parameters}
    \end{table}
    
    \begin{figure}[H]
        \begin{center}
    	\includegraphics[clip,width = 10.0cm]{graphics/after_up_bid.depth.eps}
        \end{center}
        \caption{板上昇直後初期デプス({\rm Best bid})}
    \end{figure}
    \begin{figure}[H]
        \begin{center}
    	\includegraphics[clip,width = 10.0cm]{graphics/after_up_ask.depth.eps}
        \end{center}
        \caption{板上昇直後初期デプス({\rm Best ask})}
    \end{figure}
    \begin{figure}[H]
        \begin{center}
    	\includegraphics[clip,width = 10.0cm]{graphics/after_down_bid.depth.eps}
        \end{center}
        \caption{板下降直後初期デプス({\rm Best bid})}
    \end{figure}
    \begin{figure}[H]
        \begin{center}
    	\includegraphics[clip,width = 10.0cm]{graphics/after_down_ask.depth.eps}
        \end{center}
        \caption{板下降直後初期デプス({\rm Best ask})}
    \end{figure}
    
\underline{\large 到着率}\\
	$M/M/1$の待ち行列理論では一度に複数単位到着する確率は$0$としている．実際の注文は一度に複数単位到着することが多いから，理論に合わせるために
    複数単位の到着を一単位の到着の複数回ということに読み直す必要がある．到着数の単位について，本研究においては$1$枚一単位，$10$枚一単位，
    $30$枚一単位の三つの場合を考える．到着率とは一秒あたりの到着数のことである．以下に示す到着率は，
    $(1)$単純に到着数を測ったもの，
    $(2)$毎度$1$枚ずつ到着すると見做して到着率を測ったもの($N$枚の到着は$1$枚の到着の$N$回分)，
    $(3)$$10$枚累積した時点を一回の到着として到着数を測ったもの，
    $(4)$$30$枚累積した時点を一回の到着として到着数を測ったもの，の四種類を計算した．\cite{miyazaki}に倣い，注文の到着率の最尤推定量を次の式で計算する．
    \begin{align}
    	\frac{\mbox{観測時間内の到着数}}{\mbox{観測時間}}.
    \end{align}
    観測時間はザラバ全体(昼休みがある場合は午前午後で分ける)とし，時間単位は秒である．
    データの到着時間は秒単位まで切り捨てられているが，実際の到着時間は実数秒であると考える．
    \begin{table}[H]
    	\centering
        \caption{指値/成行注文の到着率 単純に到着数を測ったもの\ ($2007$年)}
    	\begin{tabularx}{\linewidth}{l||llll} \bhline{1.5pt}
        \label{arrival_rate_per_second_1}
         	{\rm Arrival Rate Per Second} & \lambda_B & \lambda_A & \mu_A & \mu_B \\ \hline
			{\rm Mean} & $0.440430079307341$ & $0.429770731607785$ & $0.42123513769926$ & $0.42834751029013$ \\ \hline
			{\rm S.D.} & $0.139350721669983$ & $0.134820939951023$ & $0.151662215771227$ & $0.160366521869234$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}
    
    \begin{table}[H]
    	\centering
        \caption{指値/成行注文の到着率 一回の到着は$1$枚として到着数を測ったもの\ ($2007$年)}
    	\begin{tabularx}{\linewidth}{l||llll} \bhline{1.5pt}
        \label{arrival_rate_per_second_2}
        	{\rm Arrival Rate Per Second} & \lambda_B & \lambda_A & \mu_A & \mu_B \\ \hline
			{\rm Mean} & $4.04720476425838$ & $4.03655030768043$ & $4.86637047632663$ & $4.89119891472509$ \\ \hline
			{\rm S.D.} & $1.63421331941915$ & $1.62678973960703$ & $2.06954754281546$ & $2.18770444650317$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}
    
    \begin{table}[H]
    	\centering
        \caption{指値/成行注文の到着率 $10$枚累積した時点を一回の到着として到着数を測ったもの\ ($2007$年)}
    	\begin{tabularx}{\linewidth}{l||llll} \bhline{1.5pt}
        \label{arrival_rate_per_second_3}
        	{\rm Arrival Rate Per Second} & \lambda_B & \lambda_A & \mu_A & \mu_B \\ \hline
			{\rm Mean} & $0.404665416528414$ & $0.403597612483072$ & $0.486585672358297$ & $0.489064243868232$ \\ \hline
			{\rm S.D.} & $0.163421290234038$ & $0.162676317541532$ & $0.206955155383898$ & $0.218769843276613$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}
    
    \begin{table}[H]
    	\centering
        \caption{指値/成行注文の到着率 $30$枚累積した時点を一回の到着として到着数を測ったもの\ ($2007$年)}
    	\begin{tabularx}{\linewidth}{l||llll} \bhline{1.5pt}
        \label{arrival_rate_per_second_4}
        	{\rm Arrival Rate Per Second} & \lambda_B & \lambda_A & \mu_A & \mu_B \\ \hline
			{\rm Mean} & $0.134847084292512$ & $0.134493211764554$ & $0.162157327962169$ & $0.162979523115285$ \\ \hline
			{\rm S.D.} & $0.0544755143646112$ & $0.0542254514351687$ & $0.0689828043027468$ & $0.07292086367212$ \\ \bhline{1.5pt}
        \end{tabularx}
    \end{table}

\begin{comment}
    上表の結果は\cite{li_hui_endo_kishimoto}の結果と大分違った．\cite{li_hui_endo_kishimoto}では到着率を分単位で計算していて，
    その結果は$\lambda_B=3.77, \lambda_A=3.72, \mu_A=4.71, \mu_B=4.65$である．今回の結果を$60$倍してもこの数字には近くない．
    但し，\cite{li_hui_endo_kishimoto}が基にしているデータ期間は$2006/12/11 \sim 2007/12/13$であり，
    今回のデータは$2007/01/04 \sim 2007/12/28$であるから，およそ$10$日間のズレがある．それでも計算された結果があまりにも違った．\\
    \mbox{}\\
\end{comment}
    
\underline{\large 推移確率行列}\\
	式(\refeq{eq:transient_probability_matrix})で定義される転移確率の理論値を計算する．到着率のパラメータは先述の三種類のものを使った．
    行列要素の括弧の中の数値は標準偏差を表す．
    \begin{description}
    	\item[実際に観測された推移確率]\mbox{}\\
        	上下板が同時に動いた箇所のみ勘定した結果を示しておく．
        	\begin{align}
    			\left(
    			\begin{array}{@{\,}cc@{\,}}
    				p_{UU} & p_{UD} \\
            		p_{DU} & p_{DD}
    			\end{array}
    			\right)
                = \left(
    			\begin{array}{@{\,}cc@{\,}}
    				\substack{0.323 \\ (0.298)} & \substack{0.677 \\ (0.298)} \\
            		\substack{0.682 \\ (0.284)} & \substack{0.318 \\ (0.284)}
    			\end{array}
    			\right).
    		\end{align}

        \item[$10$枚累積した時点を一回の到着として測った到着数による到着率(10枚を一単位として計算)]\mbox{}\\
        	\begin{align}
    			\left(
    			\begin{array}{@{\,}cc@{\,}}
    				p_{UU} & p_{UD} \\
            		p_{DU} & p_{DD}
    			\end{array}
    			\right)
                = \left(
    			\begin{array}{@{\,}cc@{\,}}
    				\substack{0.0567 \\ (0.0936)} & \substack{0.941 \\ (0.0929)} \\
            		\substack{0.946 \\ (0.0802)} & \substack{0.0535 \\ (0.0826)}
    			\end{array}
    			\right).
    		\end{align}
        
        \item[$30$枚累積した時点を一回の到着として測った到着数による到着率(30枚を一単位として計算)]\mbox{}\\
        	\begin{align}
    			\left(
    			\begin{array}{@{\,}cc@{\,}}
    				p_{UU} & p_{UD} \\
            		p_{DU} & p_{DD}
    			\end{array}
    			\right)
                = \left(
    			\begin{array}{@{\,}cc@{\,}}
    				\substack{0.06799 \\ (0.0655)} & \substack{0.922 \\ (0.0793)} \\
            		\substack{0.922 \\ (0.0876)} & \substack{0.0655 \\ (0.0647)}
    			\end{array}
    			\right).
    		\end{align}
    \end{description}
    
    \mbox{}\\
    
\underline{\large 転移確率から計算されるモデル上の分散と{\rm Realized volatility}との比較}\\
    先に計算した転移確率$p_{UU}, p_{UD}, p_{DU}, p_{DD}$に
    期待される変動回数の情報を与えれば，一つのセッションでの板の変動の仕方を確率で表現することができるようになる．
    確率で変動を表現できればモデル上の価格の分散を計算することもできる．この寸法で板の変動から計算される{\rm volatility}を算出し，
    実際に観測される{\rm Realized volatility}と比較することでモデルと現実の整合度の一つの評価指標を得る．
    遠藤\cite{endo_zuo_kishimoto}の結果から，板の変動が一次の{\rm Markov}過程をなすと考えて良いことが示唆されている．離散時間{\rm Markov}過程の式で表現すれば，
    時点$n$での状態を表す確率変数$X_n$からなる確率過程$\{X_n\}$の転移確率は
    \begin{align}
    	\cprob{X_{n+1}=i_{n+1}}{X_0=i_0,X_1=i_1,\cdots,X_n=i_n} = \cprob{X_{n+1}=i_{n+1}}{X_n=i_n}
    \end{align}
    で表現できるから，$m$時点先までの状態の列$\{i_n, i_{n+1}, i_{n+2}, \cdots, i_{n+m}\}$に対する確率を
    \begin{align}
    	&\prob{X_{n+m}=i_{n+m},\ X_{n+m-1}=i_{n+m-1},\ X_{n+m-2}=i_{n+m-2}, \cdots, X_n=i_n} \\
        &\quad= \prob{X_n=i_n}\cprob{X_{n+1}=i_{n+1}}{X_n=i_n}\cprob{X_{n+2}=i_{n+2}}{X_{n+1}=i_{n+1}} \cdots \cprob{X_{n+m}=i_{n+m}}{X_{n+m-1}=i_{n+m-1}}
    \end{align}
    と計算することができる．本研究で考える板の変動の状態は$Up, Down$の二種類である．また転移確率の計算に用いたパラメータは一つのセッション(一日の前場と後場)
    毎に計算しているので，一つのセッションにおける{\rm Markov}過程は時間に関して一様と見做す．この下でならば，例えば板が
    $\{Up \to Down \to Down \to Up \to Down\}$の順で$5$回移動すれば，その確率は初期分布$p_U$と転移確率$p_{UU}, p_{UD}, p_{DU}, p_{DD}$を用いて
    \begin{align}
    	\prob{Up \to Down \to Down \to Up \to Down} = p_U \times p_{UD} \times p_{DD} \times p_{DU} \times p_{UD}
    \end{align}
    と表現される．
	一般に$T(\geq 1)$ステップ後に価格が$N$ティックだけ変動する確率を計算したい．$T$は一つのセッションでの板の変動回数を表すと考えている．
    $T$ステップで動く幅は高々$T$ティックであるから$N$は$[-T, T]$の範囲に収まる．
    $T$ステップの中上昇回数と下降回数の差が$N$となれば良いから，板の上昇回数は$(N+T)/2$，下降回数は$(T-N)/2$と計算される．
    簡便にするため$u$回上昇し$d$回下降したとする．$d \times u$の格子を用意して考えれば，考えるべきは左下隅のノードから右上隅のノード
    までの最短経路の選択方法である．格子の作り方から，格子を上方向に進行することは板が上昇する状態に対応し，格子を右方向に進行することは
    板が下降する状態に対応する．格子の各ノードにて，経路を右方向または左方向に曲がるかまたは直進するかの四種類の選択が転移確率に対応する．
    
    %板の動きの図，三角形の格子図，三角形の格子図の回転図を載せる
    \begin{picture}(100,150)
    	\setlength{\unitlength}{5mm}
  		\multiput(10,0)(1,0){16}{\line(0,1){10}}
  		\multiput(10,0)(0,1){11}{\line(1,0){15}}
        \thicklines
        \put(10,0){\vector(1,0){1}}
        \put(10,0){\vector(0,1){1}}
    \end{picture}
    
    \begin{table}[H]
    	\centering
        \caption{格子のノードに於ける進行方向の選択と転移確率との対応表}
        \begin{tabular}{l|l} \bhline{1.5pt}
        	進行方向 & 転移確率 \\ \hline \hline
            上方向に直進$(\uparrow \uparrow)$ & $p_{UU}$ \\ \hline
            右方向に右折$(\uparrow \to)$ & $p_{UD}$ \\ \hline
            上方向に左折$(\to \uparrow)$ & $p_{DU}$ \\ \hline
            右方向に直進$(\to \to)$ & $p_{DD}$ \\ \bhline{1.5pt}
    	\end{tabular}
    \end{table}
    
    注意するべきは，格子上を動く時，初めの動きの方向が上か右か定まった下では，
    最終的な位置と到達までの曲がる回数が等しい経路は，そこを通る確率が等しいということである．
    解説しておく．$u$または$d$が$0$である場合は板が$T$回上昇するまたは$T$回下降するだけであるから，
    確率はそれぞれ
    \begin{align}
    	p_U \times p_{UU}^{T-1},\quad p_D \times p_{DD}^{T-1},
    \end{align}
    となる．以降の議論は$u \geq 1$かつ$d \geq 1$の場合で考える．
    初めの方向選択での場合分けが必要なのは初めの動きの向きが{\rm Markov}連鎖の転移確率ではなく初期分布で与えられるためである．
    格子上の進行方向の上，右を$U,D$に対応させて表現すると，$u$回上がって$d$回下がる経路は$u$個の$U$と$d$個の$D$の順列で表現できる．
    \begin{align}
    	\mbox{例:}UUDDDUD\cdots U.
    \end{align}
    始めの状態で場合を分ける下では順列の総数でなくその半分の数を経路数とする．
    $u \times d$の格子上を最短経路で進む時，はじめに上方向に動いた下で$1$回曲がる経路数は，$\{UUU\cdots U\}$のグループも
    $\{DDD\cdots D\}$のグループも分割しないで作る順列を考えて
    \begin{align}
    	\binom{u-1}{0} \times \binom{d-1}{0}
    \end{align}
    と表現できる．括弧は二項係数を表す．この確率は
    \begin{align}
    	p_U \times p_{UD}^1 p_{DU}^0 p_{UU}^{u-1-0} p_{DD}^{d-1-0}
    \end{align}
    である．はじめに上方向に動いた下で$2$回曲がる経路数は，$\{UUU\cdots U\}$のグループを二分割，
    $\{DDD\cdots D\}$のグループを分割しないで作る順列を考えて
    \begin{align}
    	\binom{u-1}{1} \times \binom{d-1}{0}
    \end{align}
    と表現できる．$u-1$通りの経路ができるが，どの経路もそこを通る確率は
    \begin{align}
    	p_U \times p_{UD}^1 p_{DU}^1 p_{UU}^{u-1-1} p_{DD}^{d-1-0}
    \end{align}
    である．$\{UUU\cdots U\}\{DDD\cdots D\}$を並べて作る列には$u+d-1$個の$U$と$D$の結合関係がある．$\{UUU\cdots U\}$のグループも$\{DDD\cdots D\}$のグループも分割
    しなければ，結合関係$"UU"$が$u-1$個，結合関係$"DD"$が$d-1$個，結合関係$"UD"$が$1$個ある．$\{UUU\cdots U\}$のグループを二分割，
    $\{DDD\cdots D\}$のグループは分割しない場合，$UUU\cdots U$の間に$DDD\cdots D$の塊が食い込むから，結合関係$"UU"$は$1$個減り$u-2$個，
    結合関係$"DD"$は$d-1$個，結合関係$"UD"$が$1$個，結合関係$"DU"$が$1$個となる．結合関係と転移確率は対応し，
    それぞれの結合関係の個数は$u-1$通りの経路で等しいから，どの経路を通る確率も等しくなるのである．
    
    はじめに上方向に動いた下で$3$回曲がる経路数は，$\{UUU\cdots U\}$のグループも
    $\{DDD\cdots D\}$のグループも二分割して作る順列を考えて
    \begin{align}
    	\binom{u-1}{1} \times \binom{d-1}{1}
    \end{align}
    と表現できる．今度は結合関係$"DD"$の数が一つ減り結合関係$"UD"$の数が一つ増える．そして先と同じ理由でどの経路でも通る確率は等しく，それは
    \begin{align}
    	p_U \times p_{UD}^2 p_{DU}^1 p_{UU}^{u-1-1} p_{DD}^{d-1-1}
    \end{align}
    である．はじめに上方向に動いた下で$4$回曲がる経路数は，$\{UUU\cdots U\}$のグループを三分割，
    $\{DDD\cdots D\}$のグループを二分割して作る順列を考えて
    \begin{align}
    	\binom{u-1}{2} \times \binom{d-1}{1}
    \end{align}
    と表現できる．今度は結合関係$"UU"$の数が一つ減り結合関係$"DU"$の数が一つ増える．そして先と同じ理由でどの経路でも通る確率は等しく，それは
    \begin{align}
    	p_U \times p_{UD}^2 p_{DU}^2 p_{UU}^{u-1-2} p_{DD}^{d-1-1}
    \end{align}
    である．帰納的に考えれば，一般に$2k+1(k=0,1,2,\cdots)$回曲がる経路を通る確率は
    \begin{align}
    	p_U \times \binom{u-1}{k} \times \binom{d-1}{k} \times p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
    \end{align}
    で与えられ，$2k(k=1,2,\cdots)$回曲がる経路を通る確率は
    \begin{align}
    	p_U \times \binom{u-1}{k} \times \binom{d-1}{k-1} \times p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-1-k} p_{DD}^{d-1-(k-1)} 
        = p_U \times \binom{u-1}{k} \times \binom{d-1}{k-1} \times p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-1-k} p_{DD}^{d-k}
    \end{align}
    で与えられる．
    始めに格子状を右に進行する下での確率について，上の議論で$U$と$D$を入れ替えれば良い．つまり，始めに格子状を右に進行する下で
    $2k+1(k=0,1,2,\cdots)$回曲がる経路を通る確率は
    \begin{align}
    	p_D \times \binom{u-1}{k} \times \binom{d-1}{k} \times p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
    \end{align}
    で与えられ，$2k(k=1,2,\cdots)$回曲がる経路を通る確率は
    \begin{align}
    	p_D \times \binom{u-1}{k-1} \times \binom{d-1}{k} \times p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-k} p_{DD}^{d-1-k}
    \end{align}
    で与えられる．
    格子状を何回まで曲がることができるかの問題を考えねばならない．場合分けした表を示す．
    \begin{table}[H]
    	\centering
        \begin{tabular}{c|c} \bhline{1.5pt}
        	場合 & 曲がることができる回数の最大値 \\ \hline \hline
        	初期状態が上昇で上昇下降回数が$u > d$ & $2d$ \\ \hline
            初期状態が下降で上昇下降回数が$u > d$ & $2d-1$ \\ \hline
            初期状態が上昇で上昇下降回数が$u < d$ & $2u-1$ \\ \hline
            初期状態が下降で上昇下降回数が$u < d$ & $2u$ \\ \hline
            初期状態が上昇で上昇下降回数が$u = d$ & $2u-1$ \\ \hline
            初期状態が下降で上昇下降回数が$u = d$ & $2u-1$ \\ \hline
        \end{tabular}
    \end{table}
    
    以上の準備の下で，$u+d$ステップ後に$u-d$だけ今の位置からずれる確率を計算することができる．初めの表現に直せば，
    $T$ステップの後に$N$だけ今の位置からずれる確率を表現できる．
    \begin{description}
    	\item[$u>d \geq 1$の場合]
        	\begin{align}
        		& p_U \sum_{k=0}^{d-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=1}^{d} \binom{u-1}{k} \binom{d-1}{k-1} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-1-k} p_{DD}^{d-k} \\
            		&\quad+ p_D \sum_{k=0}^{d-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=1}^{d-1} \binom{u-1}{k-1} \binom{d-1}{k} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-k} p_{DD}^{d-1-k} \\
                &= p_U \sum_{k=0}^{d-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=0}^{d-1} \binom{u-1}{k+1} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-1-k-1} p_{DD}^{d-k-1} \\
            		&\quad+ p_D \sum_{k=0}^{d-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=0}^{d-2} \binom{u-1}{k} \binom{d-1}{k+1} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-k-1} p_{DD}^{d-1-k-1} \\
                &= p_D \binom{u-1}{d-1} p_{UD}^{d-1} p_{DU}^{d} p_{UU}^{u-d} \\
                	&\quad+ p_U \sum_{k=0}^{d-1} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-2-k} p_{DD}^{d-1-k} \left( \binom{u-1}{k}p_{UU} + \binom{u-1}{k+1}p_{DU} \right) \\
                	&\quad+ p_D \sum_{k=0}^{d-2} \binom{u-1}{k} p_{UD}^{k} p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-2-k} \left( \binom{d-1}{k}p_{DD} + \binom{d-1}{k+1}p_{UD} \right).
            \end{align}
            ただし$d=1$の場合は最終段第三項を$0$としておく．
        \item[$1 \leq u<d$の場合]
        	\begin{align}
            	& p_U \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=1}^{u-1} \binom{u-1}{k} \binom{d-1}{k-1} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-1-k} p_{DD}^{d-k} \\
            		&\quad+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=1}^{u} \binom{u-1}{k-1} \binom{d-1}{k} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-k} p_{DD}^{d-1-k} \\
                &= p_U \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=0}^{u-2} \binom{u-1}{k+1} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-1-k-1} p_{DD}^{d-k-1} \\
            		&\quad+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k+1} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-k-1} p_{DD}^{d-1-k-1} \\
                &= p_U \binom{d-1}{u-1} p_{UD}^{u} p_{DU}^{u-1} p_{DD}^{d-u} \\
                	&\quad+ p_U \sum_{k=0}^{u-2} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-2-k} p_{DD}^{d-1-k} \left( \binom{u-1}{k}p_{UU} + \binom{u-1}{k+1}p_{DU} \right) \\
                	&\quad+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} p_{UD}^{k} p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-2-k} \left( \binom{d-1}{k}p_{DD} + \binom{d-1}{k+1}p_{UD} \right).
            \end{align}
            ただし$u=1$の場合は最終段第二項を$0$としておく．
        \item[$u=d \geq 1$の場合]
        	\begin{align}
            	& p_U \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=1}^{u-1} \binom{u-1}{k} \binom{d-1}{k-1} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-1-k} p_{DD}^{d-k} \\
            		&\quad+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=1}^{u-1} \binom{u-1}{k-1} \binom{d-1}{k} p_{UD}^{k} p_{DU}^{k} p_{UU}^{u-k} p_{DD}^{d-1-k} \\
                &= p_U \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_U \sum_{k=0}^{u-2} \binom{u-1}{k+1} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-1-k-1} p_{DD}^{d-k-1} \\
            		&\quad+ p_D \sum_{k=0}^{u-1} \binom{u-1}{k} \binom{d-1}{k} p_{UD}^k p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-1-k}
            		+ p_D \sum_{k=0}^{u-2} \binom{u-1}{k} \binom{d-1}{k+1} p_{UD}^{k+1} p_{DU}^{k+1} p_{UU}^{u-k-1} p_{DD}^{d-1-k-1} \\
                &= p_U p_{UD}^{u} p_{DU}^{u-1} + p_D p_{UD}^{u-1} p_{DU}^{u} \\
                	&\quad+ p_U \sum_{k=0}^{u-2} \binom{d-1}{k} p_{UD}^{k+1} p_{DU}^k p_{UU}^{u-2-k} p_{DD}^{d-1-k} \left( \binom{u-1}{k}p_{UU} + \binom{u-1}{k+1}p_{DU} \right) \\
                	&\quad+ p_D \sum_{k=0}^{u-2} \binom{u-1}{k} p_{UD}^{k} p_{DU}^{k+1} p_{UU}^{u-1-k} p_{DD}^{d-2-k} \left( \binom{d-1}{k}p_{DD} + \binom{d-1}{k+1}p_{UD} \right).
            \end{align}
            ただし$u=d=1$の場合は最終段第二項と第三項を$0$としておく．
    \end{description}

\end{document}
